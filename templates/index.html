<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üåæ CropAI - Smart Plant Disease Detection</title>
  <style>
    /* Reset */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #c9f0d6, #a8ddb5);
      color: #2f4f2f;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Pest Risk Widget */
    .pest-risk-widget {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 20px;
      margin: 30px 0;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      border: 2px solid #e0e0e0;
    }
    
    .risk-indicator {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      border-radius: 15px;
      font-weight: 600;
    }
    
    .risk-green {
      background: linear-gradient(135deg, #d4edda, #c3e6cb);
      border: 2px solid #28a745;
      color: #155724;
    }
    
    .risk-yellow {
      background: linear-gradient(135deg, #fff3cd, #fce4b6);
      border: 2px solid #ffc107;
      color: #856404;
    }
    
    .risk-red {
      background: linear-gradient(135deg, #f8d7da, #f1b0b7);
      border: 2px solid #dc3545;
      color: #721c24;
    }
    .risk-black {
    background: linear-gradient(135deg, #b0b0b0, #444444);
    border: 2px solid #111;
    color: #222;
    }

    .risk-emoji {
      font-size: 2.5rem;
      line-height: 1;
    }
    .risk-content h3 {
      margin: 0 0 8px 0;
      font-size: 1.3rem;
      font-weight: 700;
    }
    
    .weather-summary {
      margin: 5px 0;
      font-size: 0.95rem;
      opacity: 0.8;
    }
    
    .threats {
      margin-top: 10px;
      font-size: 0.9rem;
      font-weight: 500;
    }

    /* Header */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      background-color: #356859;
      color: #e2f0db;
      font-weight: 700;
      font-size: 1.25rem;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    header .logo {
      font-size: 1.6rem;
      user-select: none;
    }
    nav a {
      color: #e2f0db;
      margin-left: 25px;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s ease;
    }
    nav a:hover {
      color: #a8ddb5;
    }

    /* Hero */
    .hero {
      text-align: center;
      max-width: 650px;
      margin: 40px auto 60px auto;
      padding: 0 20px;
    }
    .hero h1 {
      font-size: 3.2rem;
      margin-bottom: 15px;
      font-weight: 900;
      letter-spacing: 0.1em;
    }
    .hero p {
      font-size: 1.3rem;
      color: #3c6e47;
      font-weight: 600;
      margin-bottom: 55px;
    }
    .hero img {
      max-width: 100%;
      height: auto;
      margin-top: -30px;
      opacity: 0.85;
    }

    /* Upload & Preview Container */
    .upload-section {
      max-width: 900px;
      margin: 0 auto 60px;
      padding: 30px 20px 40px;
      background: #eff7e0cc;
      border-radius: 18px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }
    .upload-container {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-start;
    }

    /* Upload Form */
    .upload-form {
      max-width: 350px;
      flex: 1 1 350px;
      text-align: center;
    }
    .file-input {
      display: block;
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 2px solid #a8ddb5;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      color: #2f4f2f;
      background-color: #ffffffee;
      transition: background-color 0.3s ease;
      margin-bottom: 20px;
      box-sizing: border-box;
    }
    .file-input.dragover {
      background-color: #a8ddb550;
    }

    .or-divider {
      display: flex;
      align-items: center;
      margin: 25px 0 30px 0;
      color: #6b8e59;
      font-weight: 600;
      justify-content: center;
    }
    .or-divider::before,
    .or-divider::after {
      content: "";
      flex-grow: 1;
      height: 1px;
      background-color: currentColor;
      margin: 0 15px;
      border-radius: 2px;
    }

    button.capture-btn {
      display: block;
      margin: 0 auto 20px;
      background-color: #4a7c2f;
      color: white;
      font-size: 1.2rem;
      padding: 14px 32px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.03em;
      transition: background-color 0.4s ease;
      width: 100%;
    }
    button.capture-btn:hover {
      background-color: #375c21;
    }

    video#video {
      width: 100%;
      max-width: 320px;
      height: 240px;
      border-radius: 22px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      margin-bottom: 15px;
      border: 3px solid #a8ddb5;
      display: none;
      object-fit: cover;
    }

    button.detect-btn {
      background: linear-gradient(135deg, #6aaf4d, #4a7c2f);
      font-weight: 700;
      color: white;
      font-size: 1.25rem;
      padding: 18px 40px;
      border-radius: 28px;
      border: none;
      cursor: pointer;
      letter-spacing: 0.05em;
      width: 100%;
      box-shadow: 0 8px 16px rgba(0,0,0,0.25);
      transition: background 0.4s ease;
      display: block;
    }
    button.detect-btn:hover {
      background: linear-gradient(135deg, #4a7c2f, #3e6b20);
    }

    /* Loading animation */
    .loading {
      margin: 40px auto 30px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 6px solid #4a7c2f;
      border-top: 6px solid #c9f0d6;
      animation: spin 1.2s linear infinite;
      display: none;
    }
    @keyframes spin {
      0% {transform: rotate(0deg);}
      100% {transform: rotate(360deg);}
    }

    /* Image Preview */
    .image-preview {
      max-width: 350px;
      flex: 1 1 350px;
      background: #ffffffcc;
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .image-preview p {
      color: #567945;
      font-size: 1.1rem;
      font-weight: 600;
    }
    .uploaded-img {
      border-radius: 12px;
      max-width: 100%;
      max-height: 280px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.25);
      margin-top: 10px;
      object-fit: contain;
    }

    /* Results Section */
    .results-section {
      max-width: 1200px;
      margin: 0 auto 60px;
      padding: 0 20px;
    }

    .detection-result {
      background: #ffffff;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      border-left: 8px solid #4a7c2f;
    }

    .result-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .disease-info h2 {
      margin: 0;
      font-size: 2rem;
      color: #2f4f2f;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .severity-badge {
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .severity-high {
      background-color: #ff4757;
      color: white;
    }

    .severity-medium {
      background-color: #ffa502;
      color: white;
    }

    .severity-none {
      background-color: #2ed573;
      color: white;
    }

    .severity-unknown {
      background-color: #747d8c;
      color: white;
    }

    /* Enhanced Results Section */
    .treatment-duration, .success-rate {
      background: #e8f4fd;
      border: 2px solid #0984e3;
      border-radius: 10px;
      padding: 12px 15px;
      margin: 10px 0;
      font-weight: 600;
      color: #2d3436;
      display: inline-block;
      margin-right: 15px;
    }

    .urgency-critical {
      background: #ff7675;
      color: white;
    }

    .urgency-moderate {
      background: #fdcb6e;
      color: #2d3436;
    }

    .urgency-routine {
      background: #55a3ff;
      color: white;
    }

    .urgency-precautionary {
      background: #a29bfe;
      color: white;
    }

    .confidence-score {
      background: #e8f5e8;
      padding: 10px 15px;
      border-radius: 15px;
      color: #2f4f2f;
      font-weight: 600;
    }

    /* Recommendations Grid */
    .recommendations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 25px;
      margin-top: 30px;
    }

    .recommendation-card {
      background: linear-gradient(135deg, #f8fff8, #e8f5e8);
      border-radius: 15px;
      padding: 25px;
      border: 2px solid #c9f0d6;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .recommendation-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
    }

    .recommendation-card h3 {
      color: #2f4f2f;
      font-size: 1.3rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
    }

    .recommendation-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .recommendation-list li {
      background: rgba(255, 255, 255, 0.7);
      margin: 8px 0;
      padding: 12px 15px;
      border-radius: 10px;
      border-left: 4px solid #4a7c2f;
      font-weight: 500;
      line-height: 1.4;
      transition: background-color 0.3s ease;
    }

    .recommendation-list li:hover {
      background: rgba(255, 255, 255, 0.9);
    }

    .fertilizer-advice {
      background: #fff3cd;
      border: 2px solid #ffeaa7;
      padding: 20px;
      border-radius: 15px;
      margin: 20px 0;
      font-weight: 600;
      color: #856404;
    }

    .fertilizer-advice::before {
      content: "üå± ";
      font-size: 1.2em;
      margin-right: 8px;
    }

    .confidence-warning {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      color: #856404;
      font-weight: 600;
      text-align: center;
    }

    /* Quick instructions */
    .instructions {
      max-width: 560px;
      margin: 0 auto 50px;
      font-size: 1rem;
      color: #3c6e47;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
    }
    .instruction-item {
      flex: 1 1 140px;
      display: flex;
      align-items: center;
      margin: 12px 8px;
      color: #356859;
      font-weight: 600;
    }
    .instruction-item span {
      font-size: 1.7rem;
      margin-right: 12px;
    }

    /* Footer */
    footer {
      background-color: #356859;
      color: #e2f0db;
      text-align: center;
      padding: 16px 0;
      font-weight: 600;
      font-size: 0.9rem;
      margin-top: auto;
      box-shadow: inset 0 1px 10px #477655;
    }
    footer a {
      color: #c9efd3;
      text-decoration: none;
      margin: 0 12px;
    }
    footer a:hover {
      text-decoration: underline;
    }

    /* Responsive */
    @media (max-width: 800px) {
      .upload-container {
        flex-direction: column;
        gap: 25px;
      }
      .upload-form, .image-preview {
        max-width: 100%;
        flex: 1 1 100%;
      }
      video#video {
        max-width: 100%;
        height: auto;
      }
      .recommendations-grid {
        grid-template-columns: 1fr;
      }
      .result-header {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
      }
      .disease-info h2 {
        justify-content: center;
        font-size: 1.8rem;
      }
      .instructions {
        flex-direction: column;
        text-align: center;
      }
      .instruction-item {
        justify-content: center;
      }
    }

    /* Print styles */
    @media print {
      .upload-section, .instructions, footer, header {
        display: none;
      }
      .results-section {
        margin: 0;
        padding: 0;
      }
    }
  </style>
</head>

<body>
  <header>
    <div class="logo">üåæ CropAI</div>
    <nav>
      <a href="#">Home</a>
      <a href="#">About</a>
      <a href="#">Dashboard</a>
      <a href="#">Contact</a>
    </nav>
  </header>

  <section class="hero">
    <h1>AI-Powered Plant Health Diagnosis üå±</h1>
    <p>Upload or capture a photo of your crop leaf for instant disease detection and expert treatment recommendations.</p>
    
    
    <img src="https://img.icons8.com/color/96/000000/leaf.png" alt="Leaf Illustration" />
  </section>

  <section class="upload-section">
    <div class="upload-container">
      <form id="upload-form" method="POST" enctype="multipart/form-data" class="upload-form">
        <input
          type="file"
          id="file"
          name="file"
          accept="image/png, image/jpeg"
          class="file-input"
          aria-label="Choose leaf photo to upload"
          required
        />

        <div class="or-divider">or</div>

        <video id="video" autoplay playsinline></video>
        <button id="start-camera" class="capture-btn" type="button">üì± Click Leaf Photo</button>
        <button id="capture-photo" class="capture-btn" type="button" style="display:none;">üì∏ Take Photo</button>


        <button id="detect-btn" class="detect-btn" type="submit">üîç Analyze Plant Health</button>

        <div id="loading" class="loading"></div>
      </form>

      <div class="image-preview" id="image-preview">
        {% if prediction %}
        <div class="prediction-result">Detection Result: <strong>{{ prediction }}</strong></div>
        {% if confidence %}
        <div style="margin: 10px 0; color: #567945; font-weight: 600;">
          Confidence: {{ "%.1f" | format(confidence * 100) }}%
        </div>
        {% endif %}
        <img
          class="uploaded-img"
          src="{{ url_for('uploaded_file', filename=img_path) }}"
          alt="Uploaded Leaf"
        />
        {% else %}
        <p>No image uploaded yet</p>
        {% endif %}
      </div>
    </div>

    <canvas id="canvas" width="320" height="240" style="display:none"></canvas>
  </section>

  {% if recommendations %}
  <section class="results-section">
    <div class="detection-result">
      <div class="result-header">
        <div class="disease-info">
          <h2>
            {% if recommendations.disease == 'No Disease Detected' %}
              ‚úÖ
            {% elif recommendations.severity == 'High' %}
              üö®
            {% elif recommendations.severity == 'Medium' %}
              ‚ö†Ô∏è
            {% else %}
              ‚ùì
            {% endif %}
            {{ recommendations.disease }}
          </h2>
        </div>
        <div class="severity-badge severity-{{ recommendations.severity.lower().replace(' ', '-') }}">
          {{ recommendations.severity }} Risk
        </div>
        {% if confidence %}
        <div class="confidence-score">
          Confidence: {{ "%.1f" | format(confidence * 100) }}%
        </div>
        {% endif %}
      </div>

      {% if recommendations.get('confidence_warning') or recommendations.get('confidence_note') %}
      <div class="confidence-warning">
        {{ recommendations.get('confidence_warning') or recommendations.get('confidence_note') }}
      </div>
      {% endif %}

      <!-- Enhanced metadata display -->
      <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
        {% if recommendations.get('urgency_level') %}
        <div class="treatment-duration urgency-{{ recommendations.urgency_level.lower().replace(' ', '-') }}">
          üö® Urgency: {{ recommendations.urgency_level }}
        </div>
        {% endif %}
        
        {% if recommendations.get('treatment_duration') %}
        <div class="treatment-duration">
          ‚è±Ô∏è Duration: {{ recommendations.treatment_duration }}
        </div>
        {% endif %}
        
        {% if recommendations.get('success_rate') %}
        <div class="success-rate">
          üìä Success Rate: {{ recommendations.success_rate }}
        </div>
        {% endif %}
      </div>

      {% if recommendations.get('cost_estimate') %}
      <div class="fertilizer-advice" style="background: #e8f5e8; border-color: #28a745;">
        üí∞ <strong>Cost Estimate:</strong> {{ recommendations.cost_estimate }}
      </div>
      {% endif %}

      <div class="fertilizer-advice">
        {{ recommendations.fertilizer_advice }}
      </div>

      <div class="recommendations-grid">
        <div class="recommendation-card">
          <h3>üö® Immediate Actions</h3>
          <ul class="recommendation-list">
            {% for action in recommendations.immediate_actions %}
            <li>{{ action }}</li>
            {% endfor %}
          </ul>
        </div>

        <div class="recommendation-card">
          <h3>üõ°Ô∏è Preventive Measures</h3>
          <ul class="recommendation-list">
            {% for measure in recommendations.preventive_measures %}
            <li>{{ measure }}</li>
            {% endfor %}
          </ul>
        </div>

        <div class="recommendation-card">
          <h3>üëÅÔ∏è Monitoring & Care</h3>
          <ul class="recommendation-list">
            {% for monitor in recommendations.monitoring %}
            <li>{{ monitor }}</li>
            {% endfor %}
          </ul>
        </div>
        
        <div class="recommendation-card">
          <h3>üåø Organic Solutions</h3>
          <ul class="recommendation-list">
            {% for solution in recommendations.organic_solutions %}
            <li>{{ solution }}</li>
            {% endfor %}
          </ul>
        </div>

        {% if recommendations.get('chemical_alternatives') %}
        <div class="recommendation-card">
          <h3>üß™ Chemical Alternatives</h3>
          <ul class="recommendation-list">
            {% for chemical in recommendations.chemical_alternatives %}
            <li>{{ chemical }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        {% if recommendations.get('enhancement_tips') %}
        <div class="recommendation-card">
          <h3>‚≠ê Enhancement Tips</h3>
          <ul class="recommendation-list">
            {% for tip in recommendations.enhancement_tips %}
            <li>{{ tip }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        {% if recommendations.get('budget_tips') %}
        <div class="recommendation-card">
          <h3>üí∞ Budget-Friendly Options</h3>
          <ul class="recommendation-list">
            {% for tip in recommendations.budget_tips %}
            <li>{{ tip }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        {% if recommendations.get('follow_up_schedule') %}
        <div class="recommendation-card">
          <h3>üìÖ Follow-up Schedule</h3>
          <ul class="recommendation-list">
            {% for period, activity in recommendations.follow_up_schedule.items() %}
            <li><strong>{{ period.title() }}:</strong> {{ activity }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      </div>

      <!-- Seasonal and Environmental Information -->
      {% if recommendations.get('seasonal_focus') %}
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
        <div class="recommendation-card" style="background: linear-gradient(135deg, #fff7ed, #fed7aa);">
          <h3>üå∏ Seasonal Focus</h3>
          <p style="font-weight: 600; color: #9a3412;">{{ recommendations.seasonal_focus }}</p>
          {% if recommendations.get('seasonal_activities') %}
          <ul class="recommendation-list">
            {% for activity in recommendations.seasonal_activities %}
            <li>{{ activity }}</li>
            {% endfor %}
          </ul>
          {% endif %}
        </div>

        {% if recommendations.get('regional_considerations') %}
        <div class="recommendation-card" style="background: linear-gradient(135deg, #eff6ff, #dbeafe);">
          <h3>üó∫Ô∏è Regional Factors</h3>
          {% if recommendations.regional_considerations.climate_challenges %}
          <p><strong>Climate Challenges:</strong></p>
          <ul class="recommendation-list">
            {% for challenge in recommendations.regional_considerations.climate_challenges %}
            <li>{{ challenge }}</li>
            {% endfor %}
          </ul>
          {% endif %}
        </div>
        {% endif %}
      </div>
      {% endif %}

      <!-- Pest Risk Integration -->
      {% if pest_risk and pest_risk.recommendations %}
      <div class="recommendation-card" style="background: linear-gradient(135deg, #fef3c7, #fde68a); margin-top: 25px;">
        <h3>üêõ Current Pest Risk Recommendations</h3>
        <div class="risk-indicator risk-{{ pest_risk.risk_color }}" style="margin-bottom: 15px;">
          <span class="risk-emoji">{{ pest_risk.risk_emoji }}</span>
          <div class="risk-content">
            <h4 style="margin: 0;">Risk Level: {{ pest_risk.risk_level }}</h4>
          </div>
        </div>
        <ul class="recommendation-list">
          {% for rec in pest_risk.recommendations %}
          <li>{{ rec }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>
  </section>
  {% endif %}

  <section class="instructions">
    <div class="instruction-item">üì∑ Clear leaf photo with good lighting</div>
    <div class="instruction-item">üéØ Focus on diseased areas if visible</div>
    <div class="instruction-item">üåû Natural light works best</div>
    <div class="instruction-item">‚úÖ Get instant AI diagnosis</div>
  </section>

  <footer>
    <a href="#">Privacy Policy</a> | <a href="#">Terms</a> | <a href="#">Contact</a><br />
    Advanced AI Plant Health Analysis System
  </footer>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const startCameraButton = document.getElementById("start-camera");
    const fileInput = document.getElementById("file");
    const uploadForm = document.getElementById("upload-form");
    const loading = document.getElementById("loading");
    const imagePreviewContainer = document.getElementById("image-preview");
    // Reference to capture button
const capturePhotoButton = document.getElementById("capture-photo");

// When camera is started, show capture button
startCameraButton.addEventListener("click", function() {
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(function(mediaStream) {
      stream = mediaStream;
      video.srcObject = mediaStream;
      video.style.display = "block";
      startCameraButton.style.display = "none";
      capturePhotoButton.style.display = "block"; // ‚úÖ show capture button
    })
    .catch(function(err) {
      alert("Could not access camera: " + err.message);
    });
});

// Handle capture click
capturePhotoButton.addEventListener("click", function() {
  if (video.style.display === "block" && stream) {
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
    canvas.toBlob(function(blob) {
      const file = new File([blob], "capture.jpg", { type: "image/jpeg" });
      if (validateFile(file)) {
        // Preview captured image
        previewImage(file);

        // Replace file input with captured image
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;

        // Hide camera after capture
        stream.getTracks().forEach(track => track.stop());
        video.style.display = "none";
        capturePhotoButton.style.display = "none";
      }
    }, "image/jpeg", 0.95);
  }
});


    video.style.display = "none";

    // Enhanced file validation
    function validateFile(file) {
      const maxSize = 10 * 1024 * 1024; // 10MB
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
      
      if (file.size > maxSize) {
        alert('File size too large. Please select an image under 10MB.');
        return false;
      }
      
      if (!allowedTypes.includes(file.type)) {
        alert('Invalid file type. Please select a JPG or PNG image.');
        return false;
      }
      
      return true;
    }

    // Enhanced drag and drop functionality
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      fileInput.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      fileInput.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      fileInput.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
      fileInput.classList.add('dragover');
    }

    function unhighlight(e) {
      fileInput.classList.remove('dragover');
    }

    fileInput.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      if (files.length > 0) {
        const file = files[0];
        if (validateFile(file)) {
          fileInput.files = files;
          previewImage(file);
        }
      }
    }
    // Image file preview functionality
    fileInput.addEventListener("change", function() {
      if (fileInput.files && fileInput.files[0]) {
        const file = fileInput.files[0];
        if (validateFile(file)) {
          previewImage(file);
        }
      }
    });
    function previewImage(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        let imgTag = imagePreviewContainer.querySelector('.uploaded-img');
        if (!imgTag) {
          imgTag = document.createElement('img');
          imgTag.classList.add('uploaded-img');
          imagePreviewContainer.innerHTML = '';
          imagePreviewContainer.appendChild(imgTag);
        }
        imgTag.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // Camera and capture functionality
    let stream = null;
    startCameraButton.addEventListener("click", function() {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(mediaStream) {
          stream = mediaStream;
          video.srcObject = mediaStream;
          video.style.display = "block";
          startCameraButton.style.display = "none";
        })
        .catch(function(err) {
          alert("Could not access camera: " + err.message);
        });
    });

    // When submitting, if camera is active, capture frame instead
    uploadForm.addEventListener("submit", function(event) {
      if (video.style.display === "block" && stream) {
        event.preventDefault();
        // Capture photo from video
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(function(blob) {
          const file = new File([blob], "capture.jpg", { type: "image/jpeg" });
          if (validateFile(file)) {
            // Build new FormData and submit via AJAX
            const formData = new FormData();
            formData.append("file", file);
            showLoading();
            fetch(uploadForm.action, {
              method: "POST",
              body: formData
            })
            .then(response => window.location.reload())
            .catch(() => {
              hideLoading();
              alert("Error analyzing image. Please try again.");
            });
          }
        }, "image/jpeg", 0.95);
      } else {
        showLoading();
      }
    });

    function showLoading() {
      loading.style.display = "block";
      document.getElementById("detect-btn").disabled = true;
    }
    function hideLoading() {
      loading.style.display = "none";
      document.getElementById("detect-btn").disabled = false;
    }

    // Hide loading on page load
    window.addEventListener("DOMContentLoaded", hideLoading);
  </script>
</body>
</html>
